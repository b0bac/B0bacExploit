import requests
from tqdm import tqdm
from CoreUtils.WeakPasswordScannerEngine import WeakPasswordScanningEngine, ScannerRegister


class ResinPasswordScanner(WeakPasswordScanningEngine):
    def __init__(self, target):
        super().__init__(target)
        self.username_list = [username for username in open(self.username_file, 'r').readlines()]
        self.password_list = [password for password in open(self.password_file, 'r').readlines()]

    def resin_login(self, host, port, protocol, username, password):
        import urllib3
        urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
        try:
            url = "%s://%s:%s/resin-admin/j_security_check?j_uri=index.php"%(str(protocol), str(host), str(port))
            flag_list = ['<th>Resin home:</th>', 'The Resin version', 'Resin Summary']
            post_data = 'j_username=%s&j_password=%s' % (username, password)
            # tqdm.write(help(ftp.login(username, password)))
            response = requests.post(url, data=post_data, verify=False, timeout=5)
            code = response.status_code
            for flag in flag_list:
                if flag in response.text or code == 408:
                    tqdm.write("\033[1;31m[+] 主机【%s】%s端口 存在Resin弱口令! 【%s   %s】" % (host, str(port), username, password))
        except Exception as exception:
            pass

    def scan(self):
        argments = []
        for target in self.target:
            for username in self.username_list:
                for password in self.password_list:
                    argments.append([target[0], int(target[1]), target[2], username.split("\n")[0], password.split("\n")[0]])
        self.percent = self.percent(argments)
        for item in self.percent:
            self.thread_pool.start_new_thread(self.resin_login, item)
        self.percent.set_description("Scanning")


ScannerRegister("ResinBrute", ResinPasswordScanner)



