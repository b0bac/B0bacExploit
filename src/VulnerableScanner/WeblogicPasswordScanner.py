import requests
from tqdm import tqdm
from CoreUtils.WeakPasswordScannerEngine import WeakPasswordScanningEngine, ScannerRegister


class WeblogicPasswordScanner(WeakPasswordScanningEngine):
    def __init__(self, target):
        super().__init__(target)
        self.username_list = [username for username in open(self.username_file, 'r').readlines()]
        self.password_list = [password for password in open(self.password_file, 'r').readlines()]

    def weblogic_login(self, host, port, protocol, username, password):
        import urllib3
        urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
        try:
            url = "%s://%s:%s/console/j_security_check"%(str(protocol), str(host), str(port))
            flag_list = ['<title>WebLogic Server Console</title>', 'javascript/console-help.js',
                         'WebLogic Server Administration Console Home', '/console/console.portal',
                         'console/jsp/common/warnuserlockheld.jsp', '/console/actions/common/']

            post_data = 'j_username=%s&j_password=%s&j_character_encoding=UTF-8' % (username, password)
            # tqdm.write(help(ftp.login(username, password)))
            response = requests.post(url, data=post_data, verify=False, timeout=5)
            for flag in flag_list:
                if flag in response.text:
                    tqdm.write("\033[1;31m[+] 主机【%s】%s端口 存在Hikvision弱口令! 【%s   %s】" % (host, str(port), username, password))
        except Exception as exception:
            pass

    def scan(self):
        argments = []
        for target in self.target:
            for username in self.username_list:
                for password in self.password_list:
                    argments.append([target[0], int(target[1]), target[2], username.split("\n")[0], password.split("\n")[0]])
        self.percent = self.percent(argments)
        for item in self.percent:
            self.thread_pool.start_new_thread(self.weblogic_login, item)
        self.percent.set_description("Scanning")


ScannerRegister("WeblogicBrute", WeblogicPasswordScanner)



